<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>פאנל ניהול - חנות חולצות כדורגל</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚙️</text></svg>">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #eef2f7;
            color: #333;
            direction: rtl;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        #login-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.75);
            display: flex; justify-content: center; align-items: center;
            z-index: 10000;
        }
        #login-form-container {
            background: #fff;
            padding: 40px 30px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            text-align: center;
            width: 90%; max-width: 380px;
            box-sizing: border-box;
        }
        #login-form-container h2 { margin-top: 0; color: #2c3e50; margin-bottom: 25px; font-size: 1.8em; font-weight: 600; }
        #login-form-container input { width: calc(100% - 24px); padding: 12px; margin-bottom: 15px; border: 1px solid #cce0ff; border-radius: 6px; font-size: 1em; box-sizing: border-box; outline: none; transition: border-color 0.3s; }
        #login-form-container input:focus { border-color: #dc3545; }
        #login-button { background: #dc3545; color: #fff; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 1.1em; font-weight: 500; width: 100%; transition: background 0.3s; }
        #login-button:hover { background: #c82333; }
        #login-error-message { color: #e74c3c; margin-top: 15px; font-weight: bold; font-size: 0.95em; }
        .container {
            max-width: 1100px;
            margin: 20px auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px #0001;
        }
        h1, h2 { text-align: center; color: #333; }
        section { margin-bottom: 45px; }
        
        /* הזמנות */
        #orders-list { margin-top: 10px; }
        .order-card {
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: background-color 0.2s ease;
        }
        .order-card:hover { background: #e9e9e9; }
        .order-card strong { color: #dc3545; }
        .order-card span { font-size: 0.9em; color: #666; }
        
        /* מוצרים */
        #product-form h2, #products-section h2 { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; margin-top: 0;}
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group input[type="url"], .form-group textarea {
            width: calc(100% - 22px); padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;
        }
        .form-group textarea { resize: vertical; min-height: 50px; max-height: 200px; }
        .options-input {
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }
        .option-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        .option-tag {
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .option-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            line-height: 1;
        }
        button[type="submit"] {
            background: #c82333; color: #fff; border: none; padding: 10px 20px; border-radius: 4px;
            cursor: pointer; font-size: 1em; display: block; width: 100%; margin-top: 20px;
        }
        button[type="submit"]:hover { background: #bd2130; }
        .products-list {
            display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;
        }
        .product-card {
            background: #f9f9f9; border: 1px solid #eee; border-radius: 6px; padding: 15px;
            width: 290px; min-width: 260px; box-sizing: border-box; margin-bottom: 10px;
            display: flex; flex-direction: column; align-items: flex-start; position: relative;
        }
        .product-card img { width: 100%; height: 140px; object-fit: cover; border-radius: 4px; margin-bottom: 10px; background: #e5e5e5; }
        .product-card .product-details { width: 100%; }
        .product-card .product-actions { width: 100%; margin-top: 10px; text-align: left; }
        .product-card button.edit-btn { background: #dc3545; color: #fff; border: none; border-radius: 4px; padding: 7px 16px; font-size: 1em; cursor: pointer; margin-right: 5px; margin-bottom: 5px; transition: background 0.2s; }
        .product-card button.edit-btn:hover { background: #c82333; }
        .product-card button.save-btn { background: #c82333; color: #fff; border: none; border-radius: 4px; padding: 7px 16px; font-size: 1em; cursor: pointer; margin-right: 5px; margin-bottom: 5px; transition: background 0.2s; }
        .product-card button.save-btn:hover { background: #bd2130; }
        .product-card button.cancel-btn { background: #6c757d; color: #fff; border: none; border-radius: 4px; padding: 7px 16px; font-size: 1em; cursor: pointer; margin-right: 5px; margin-bottom: 5px; transition: background 0.2s; }
        .product-card button.cancel-btn:hover { background: #5a6268; }
        
        /* מודאלים */
        .modal { display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: #0007; z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content {
            background: #fff; border-radius: 10px; padding: 32px 28px; direction: rtl;
            min-width: 260px; min-height: 140px; box-shadow: 0 4px 22px #0002; position: relative;
        }
        .modal-content h2, .modal-content h3 { margin: 0 0 15px 0; color: #dc3545;}
        .modal-content p { margin: 8px 0; font-size: 1.05em;}
        .modal-content .close-button {
            position: absolute; left: 18px; top: 14px;
            background: none; border: none; font-size: 1.4em; cursor: pointer; color: #888;
        }
        .modal-content .close-button:hover { color: #dc3545; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="login-overlay">
        <div id="login-form-container">
            <h2>התחבר לפאנל הניהול</h2>
            <input type="text" id="username" placeholder="שם משתמש" autofocus>
            <input type="password" id="password" placeholder="סיסמה">
            <button id="login-button">התחבר</button>
            <p id="login-error-message" style="display: none;"></p>
        </div>
    </div>
    <div class="container" id="admin-panel-content" style="display: none;">
        <h1>פאנל ניהול - חנות חולצות כדורגל ⚽</h1>

        <!-- הזמנות -->
        <section id="orders-section">
            <h2>הזמנות קיימות</h2>
            <div id="orders-list">
                <p>טוען הזמנות...</p>
            </div>
        </section>

        <!-- הוספת מוצר חדש -->
        <section id="product-form">
            <h2>הוסף חולצה חדשה</h2>
            <form id="add-product-form">
                <div class="form-group">
                    <label for="product-name">שם החולצה:</label>
                    <input type="text" id="product-name" required>
                </div>
                <div class="form-group">
                    <label for="product-description">תיאור החולצה:</label>
                    <textarea id="product-description" required></textarea>
                </div>
                <div class="form-group">
                    <label for="product-price">מחיר:</label>
                    <input type="number" id="product-price" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="product-image">כתובת URL לתמונה:</label>
                    <input type="url" id="product-image" required>
                </div>
                <div class="form-group">
                    <label for="product-sizes">מידות (הקש Enter להוספת מידה):</label>
                    <input type="text" id="product-sizes" placeholder="הקש מידה ולחץ Enter">
                    <div class="options-input">לדוגמה: S, M, L, XL, XXL</div>
                    <div class="option-tags" id="sizes-tags"></div>
                </div>
                <div class="form-group">
                    <label for="product-colors">צבעים (הקש Enter להוספת צבע):</label>
                    <input type="text" id="product-colors" placeholder="הקש צבע ולחץ Enter">
                    <div class="options-input">לדוגמה: אדום, כחול, לבן, שחור</div>
                    <div class="option-tags" id="colors-tags"></div>
                </div>
                <div class="form-group">
                    <label for="product-types">סוגים (הקש Enter להוספת סוג):</label>
                    <input type="text" id="product-types" placeholder="הקש סוג ולחץ Enter">
                    <div class="options-input">לדוגמה: בית, חוץ, שוער, אוהדים</div>
                    <div class="option-tags" id="types-tags"></div>
                </div>
                <button type="submit">הוסף חולצה</button>
            </form>
        </section>

        <!-- עריכת מוצרים -->
        <section id="products-section">
            <h2>חולצות קיימות</h2>
            <div class="products-list" id="products-list">
                <p>טוען חולצות...</p>
            </div>
        </section>
    </div>

    <!-- מודאל הזמנה -->
    <div id="order-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>פרטי הזמנה</h3>
            <p><strong>שם לקוח:</strong> <span id="modal-customer-name"></span></p>
            <p><strong>אימייל:</strong> <span id="modal-customer-email"></span></p>
            <p><strong>טלפון:</strong> <span id="modal-customer-phone"></span></p>
            <p><strong>כתובת:</strong> <span id="modal-customer-address"></span></p>
            <p><strong>סה"כ לתשלום:</strong> <span id="modal-total-amount"></span> ₪</p>
            <p><strong>תאריך הזמנה:</strong> <span id="modal-order-date"></span></p>
            <h4>פרטי פריטים:</h4>
            <ul id="modal-order-items"></ul>
        </div>
    </div>

    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyDLHENaXTeorjL87sExB1EJrH7mrEnNYOA",
        authDomain: "timetable-titus.firebaseapp.com",
        projectId: "timetable-titus",
        storageBucket: "timetable-titus.appspot.com",
        messagingSenderId: "199146911555",
        appId: "1:199146911555:web:5d9436d716dfc6de7361f6",
        measurementId: "G-JQ02VEC325"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Login
    const ADMIN_USERNAME = 'Bmiller', ADMIN_PASSWORD = 'Bmiller123';
    const loginOverlay = document.getElementById('login-overlay');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginButton = document.getElementById('login-button');
    const loginErrorMessage = document.getElementById('login-error-message');
    const adminPanelContent = document.getElementById('admin-panel-content');
    
    loginButton.addEventListener('click', () => {
        if (usernameInput.value === ADMIN_USERNAME && passwordInput.value === ADMIN_PASSWORD) {
            loginOverlay.style.display = 'none';
            adminPanelContent.style.display = 'block';
            fetchProducts();
            fetchOrders();
        } else {
            loginErrorMessage.textContent = 'שם משתמש או סיסמה שגויים.';
            loginErrorMessage.style.display = 'block';
        }
    });

    // הזמנות
    const ordersList = document.getElementById('orders-list');
    const orderDetailsModal = document.getElementById('order-details-modal');
    const modalCloseButton = orderDetailsModal.querySelector('.close-button');
    
    async function fetchOrders() {
        ordersList.innerHTML = '<p>טוען הזמנות...</p>';
        try {
            const ordersSnapshot = await db.collection('orders').orderBy('orderDate', 'desc').get();
            if (ordersSnapshot.empty) {
                ordersList.innerHTML = '<p>אין הזמנות קיימות.</p>';
                return;
            }
            ordersList.innerHTML = '';
            ordersSnapshot.forEach(doc => {
                const order = doc.data();
                const orderId = doc.id;
                const orderDate = order.orderDate ? new Date(order.orderDate.toDate()).toLocaleString('he-IL') : 'לא ידוע';
                const orderCard = document.createElement('div');
                orderCard.classList.add('order-card');
                orderCard.innerHTML = `
                    <div>
                        <strong>הזמנה #${orderId.substring(0, 8)}...</strong>
                        <p>לקוח: ${order.customerName || 'אנונימי'}</p>
                    </div>
                    <div>
                        <span>סה"כ: ${order.totalAmount ? order.totalAmount.toFixed(2) : '0.00'} ₪</span><br>
                        <span>תאריך: ${orderDate}</span>
                    </div>
                `;
                orderCard.addEventListener('click', () => showOrderDetails(order));
                ordersList.appendChild(orderCard);
            });
        } catch (error) {
            ordersList.innerHTML = '<p style="color: red;">שגיאה בטעינת הזמנות.</p>';
        }
    }
    
    function showOrderDetails(order) {
        document.getElementById('modal-customer-name').textContent = order.customerName || 'לא ידוע';
        document.getElementById('modal-customer-email').textContent = order.customerEmail || 'לא ידוע';
        document.getElementById('modal-customer-phone').textContent = order.customerPhone || 'לא ידוע';
        document.getElementById('modal-customer-address').textContent = order.customerAddress || 'לא ידוע';
        document.getElementById('modal-total-amount').textContent = order.totalAmount ? order.totalAmount.toFixed(2) : '0.00';
        document.getElementById('modal-order-date').textContent = order.orderDate ? new Date(order.orderDate.toDate()).toLocaleString('he-IL') : 'לא ידוע';
        
        const modalOrderItems = document.getElementById('modal-order-items');
        modalOrderItems.innerHTML = '';
        if (order.items && order.items.length > 0) {
            order.items.forEach(item => {
                const listItem = document.createElement('li');
                let optionsInfo = '';
                if (item.selectedSize) optionsInfo += `<br>מידה: ${item.selectedSize}`;
                if (item.selectedColor) optionsInfo += `<br>צבע: ${item.selectedColor}`;
                if (item.selectedType) optionsInfo += `<br>סוג: ${item.selectedType}`;
                
                listItem.innerHTML = `
                    <strong>${item.productName}</strong> (כמות: ${item.quantity})
                    ${optionsInfo}
                `;
                modalOrderItems.appendChild(listItem);
            });
        } else {
            modalOrderItems.innerHTML = '<li>אין פרטי פריטים עבור הזמנה זו.</li>';
        }
        orderDetailsModal.classList.add('active');
    }
    
    modalCloseButton.addEventListener('click', () => { orderDetailsModal.classList.remove('active'); });
    window.addEventListener('click', (event) => {
        if (event.target === orderDetailsModal) orderDetailsModal.classList.remove('active');
    });

    // מוצרים - הוספה
    const addProductForm = document.getElementById('add-product-form');
    const productNameInput = document.getElementById('product-name');
    const productDescriptionInput = document.getElementById('product-description');
    const productPriceInput = document.getElementById('product-price');
    const productImageInput = document.getElementById('product-image');
    const productSizesInput = document.getElementById('product-sizes');
    const productColorsInput = document.getElementById('product-colors');
    const productTypesInput = document.getElementById('product-types');
    const sizesTags = document.getElementById('sizes-tags');
    const colorsTags = document.getElementById('colors-tags');
    const typesTags = document.getElementById('types-tags');
    
    let sizes = [];
    let colors = [];
    let types = [];
    
    function addTag(array, tagsContainer, value) {
        if (value && !array.includes(value)) {
            array.push(value);
            updateTags(array, tagsContainer);
        }
    }
    
    function removeTag(array, tagsContainer, value) {
        const index = array.indexOf(value);
        if (index > -1) {
            array.splice(index, 1);
            updateTags(array, tagsContainer);
        }
    }
    
    function updateTags(array, tagsContainer) {
        tagsContainer.innerHTML = '';
        array.forEach(item => {
            const tag = document.createElement('div');
            tag.className = 'option-tag';
            tag.innerHTML = `
                ${item}
                <button type="button" onclick="removeTagByValue('${tagsContainer.id}', '${item}')">&times;</button>
            `;
            tagsContainer.appendChild(tag);
        });
    }
    
    window.removeTagByValue = function(containerId, value) {
        if (containerId === 'sizes-tags') removeTag(sizes, sizesTags, value);
        else if (containerId === 'colors-tags') removeTag(colors, colorsTags, value);
        else if (containerId === 'types-tags') removeTag(types, typesTags, value);
    };
    
    productSizesInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addTag(sizes, sizesTags, productSizesInput.value.trim());
            productSizesInput.value = '';
        }
    });
    
    productColorsInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addTag(colors, colorsTags, productColorsInput.value.trim());
            productColorsInput.value = '';
        }
    });
    
    productTypesInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addTag(types, typesTags, productTypesInput.value.trim());
            productTypesInput.value = '';
        }
    });
    
    addProductForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = productNameInput.value.trim();
        const description = productDescriptionInput.value.trim();
        const price = parseFloat(productPriceInput.value);
        const image = productImageInput.value.trim();
        
        if (!name || !description || isNaN(price) || price < 0 || !image) {
            alert('אנא מלא את כל השדות בצורה תקינה.'); 
            return;
        }
        
        try {
            await db.collection('soccer_shirts').add({
                name, 
                description, 
                price, 
                image,
                sizes: sizes.length > 0 ? sizes : null,
                colors: colors.length > 0 ? colors : null,
                types: types.length > 0 ? types : null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert('החולצה נוספה בהצלחה!');
            addProductForm.reset();
            sizes = [];
            colors = [];
            types = [];
            sizesTags.innerHTML = '';
            colorsTags.innerHTML = '';
            typesTags.innerHTML = '';
            fetchProducts();
        } catch (error) {
            alert('שגיאה בהוספת החולצה. נסה שוב.');
        }
    });

    // מוצרים - עריכה
    const productsList = document.getElementById('products-list');
    
    async function fetchProducts() {
        productsList.innerHTML = '<p>טוען חולצות...</p>';
        try {
            const productsSnapshot = await db.collection('soccer_shirts').orderBy('createdAt', 'desc').get();
            if (productsSnapshot.empty) {
                productsList.innerHTML = '<p>אין חולצות קיימות.</p>';
                return;
            }
            productsList.innerHTML = '';
            productsSnapshot.forEach(doc => {
                const product = doc.data();
                const productId = doc.id;
                const card = document.createElement('div');
                card.classList.add('product-card');
                
                let sizesText = product.sizes && product.sizes.length > 0 ? product.sizes.join(', ') : 'אין';
                let colorsText = product.colors && product.colors.length > 0 ? product.colors.join(', ') : 'אין';
                let typesText = product.types && product.types.length > 0 ? product.types.join(', ') : 'אין';
                
                card.innerHTML = `
                    <img src="${product.image}" alt="${product.name}">
                    <div class="product-details">
                        <strong>שם:</strong> <span class="prod-name">${product.name}</span><br>
                        <strong>תיאור:</strong> <span class="prod-desc">${product.description || ''}</span><br>
                        <strong>מחיר:</strong> <span class="prod-price">${product.price ? product.price.toFixed(2) : '0.00'}</span> ₪<br>
                        <strong>מידות:</strong> <span class="prod-sizes">${sizesText}</span><br>
                        <strong>צבעים:</strong> <span class="prod-colors">${colorsText}</span><br>
                        <strong>סוגים:</strong> <span class="prod-types">${typesText}</span><br>
                        <strong>תמונה:</strong> <a href="${product.image}" target="_blank" class="prod-image-link">${product.image}</a>
                    </div>
                    <div class="product-actions">
                        <button class="edit-btn">ערוך</button>
                    </div>
                `;
                
                // טופס עריכה
                const editForm = document.createElement('form');
                editForm.style.display = 'none';
                editForm.innerHTML = `
                    <div class="form-group">
                        <label>שם:</label>
                        <input type="text" class="edit-name" value="${product.name}" required>
                    </div>
                    <div class="form-group">
                        <label>תיאור:</label>
                        <textarea class="edit-desc" required>${product.description || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>מחיר:</label>
                        <input type="number" class="edit-price" step="0.01" min="0" value="${product.price ? product.price : 0}" required>
                    </div>
                    <div class="form-group">
                        <label>כתובת URL לתמונה:</label>
                        <input type="url" class="edit-image" value="${product.image}" required>
                    </div>
                    <div class="form-group">
                        <label>מידות (הקש Enter להוספת מידה):</label>
                        <input type="text" class="edit-sizes-input" placeholder="הקש מידה ולחץ Enter">
                        <div class="option-tags edit-sizes-tags"></div>
                    </div>
                    <div class="form-group">
                        <label>צבעים (הקש Enter להוספת צבע):</label>
                        <input type="text" class="edit-colors-input" placeholder="הקש צבע ולחץ Enter">
                        <div class="option-tags edit-colors-tags"></div>
                    </div>
                    <div class="form-group">
                        <label>סוגים (הקש Enter להוספת סוג):</label>
                        <input type="text" class="edit-types-input" placeholder="הקש סוג ולחץ Enter">
                        <div class="option-tags edit-types-tags"></div>
                    </div>
                    <div>
                        <button type="submit" class="save-btn">שמור</button>
                        <button type="button" class="cancel-btn">ביטול</button>
                    </div>
                `;
                card.appendChild(editForm);
                
                let editSizes = product.sizes ? [...product.sizes] : [];
                let editColors = product.colors ? [...product.colors] : [];
                let editTypes = product.types ? [...product.types] : [];
                
                const editSizesInput = editForm.querySelector('.edit-sizes-input');
                const editColorsInput = editForm.querySelector('.edit-colors-input');
                const editTypesInput = editForm.querySelector('.edit-types-input');
                const editSizesTags = editForm.querySelector('.edit-sizes-tags');
                const editColorsTags = editForm.querySelector('.edit-colors-tags');
                const editTypesTags = editForm.querySelector('.edit-types-tags');
                
                function updateEditTags(array, tagsContainer, removeCallback) {
                    tagsContainer.innerHTML = '';
                    array.forEach(item => {
                        const tag = document.createElement('div');
                        tag.className = 'option-tag';
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.innerHTML = '&times;';
                        removeBtn.addEventListener('click', () => removeCallback(item));
                        tag.appendChild(document.createTextNode(item + ' '));
                        tag.appendChild(removeBtn);
                        tagsContainer.appendChild(tag);
                    });
                }
                
                updateEditTags(editSizes, editSizesTags, (item) => {
                    editSizes = editSizes.filter(s => s !== item);
                    updateEditTags(editSizes, editSizesTags, arguments.callee);
                });
                updateEditTags(editColors, editColorsTags, (item) => {
                    editColors = editColors.filter(c => c !== item);
                    updateEditTags(editColors, editColorsTags, arguments.callee);
                });
                updateEditTags(editTypes, editTypesTags, (item) => {
                    editTypes = editTypes.filter(t => t !== item);
                    updateEditTags(editTypes, editTypesTags, arguments.callee);
                });
                
                editSizesInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const val = editSizesInput.value.trim();
                        if (val && !editSizes.includes(val)) {
                            editSizes.push(val);
                            updateEditTags(editSizes, editSizesTags, (item) => {
                                editSizes = editSizes.filter(s => s !== item);
                                updateEditTags(editSizes, editSizesTags, arguments.callee);
                            });
                        }
                        editSizesInput.value = '';
                    }
                });
                
                editColorsInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const val = editColorsInput.value.trim();
                        if (val && !editColors.includes(val)) {
                            editColors.push(val);
                            updateEditTags(editColors, editColorsTags, (item) => {
                                editColors = editColors.filter(c => c !== item);
                                updateEditTags(editColors, editColorsTags, arguments.callee);
                            });
                        }
                        editColorsInput.value = '';
                    }
                });
                
                editTypesInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const val = editTypesInput.value.trim();
                        if (val && !editTypes.includes(val)) {
                            editTypes.push(val);
                            updateEditTags(editTypes, editTypesTags, (item) => {
                                editTypes = editTypes.filter(t => t !== item);
                                updateEditTags(editTypes, editTypesTags, arguments.callee);
                            });
                        }
                        editTypesInput.value = '';
                    }
                });
                
                // אירועים לעריכה
                const editBtn = card.querySelector('.edit-btn');
                const productDetailsDiv = card.querySelector('.product-details');
                editBtn.addEventListener('click', () => {
                    productDetailsDiv.style.display = 'none';
                    card.querySelector('.product-actions').style.display = 'none';
                    editForm.style.display = 'block';
                });
                
                const cancelBtn = editForm.querySelector('.cancel-btn');
                cancelBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    editForm.style.display = 'none';
                    productDetailsDiv.style.display = '';
                    card.querySelector('.product-actions').style.display = '';
                    // איפוס הערכים המקוריים
                    editSizes = product.sizes ? [...product.sizes] : [];
                    editColors = product.colors ? [...product.colors] : [];
                    editTypes = product.types ? [...product.types] : [];
                    updateEditTags(editSizes, editSizesTags, (item) => {
                        editSizes = editSizes.filter(s => s !== item);
                        updateEditTags(editSizes, editSizesTags, arguments.callee);
                    });
                    updateEditTags(editColors, editColorsTags, (item) => {
                        editColors = editColors.filter(c => c !== item);
                        updateEditTags(editColors, editColorsTags, arguments.callee);
                    });
                    updateEditTags(editTypes, editTypesTags, (item) => {
                        editTypes = editTypes.filter(t => t !== item);
                        updateEditTags(editTypes, editTypesTags, arguments.callee);
                    });
                });
                
                editForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newName = editForm.querySelector('.edit-name').value.trim();
                    const newDesc = editForm.querySelector('.edit-desc').value.trim();
                    const newPrice = parseFloat(editForm.querySelector('.edit-price').value);
                    const newImage = editForm.querySelector('.edit-image').value.trim();
                    
                    if (!newName || !newDesc || isNaN(newPrice) || newPrice < 0 || !newImage) {
                        alert('אנא מלא את כל השדות בצורה תקינה.'); 
                        return;
                    }
                    
                    try {
                        await db.collection('soccer_shirts').doc(productId).update({
                            name: newName, 
                            description: newDesc, 
                            price: newPrice, 
                            image: newImage,
                            sizes: editSizes.length > 0 ? editSizes : null,
                            colors: editColors.length > 0 ? editColors : null,
                            types: editTypes.length > 0 ? editTypes : null
                        });
                        alert('החולצה עודכנה בהצלחה!');
                        fetchProducts();
                    } catch (error) {
                        alert('שגיאה בעדכון החולצה. נסה שוב.');
                    }
                });
                
                productsList.appendChild(card);
            });
        } catch (error) {
            productsList.innerHTML = '<p style="color: red;">שגיאה בטעינת חולצות.</p>';
        }
    }
    </script>
</body>
</html>
